name: validate iphone pr

on:
  pull_request:
    branches:
      - main
    paths:
      - 'apps/iphone/**'
      - '.github/workflows/**'

permissions:
  contents: read

jobs:
  validate:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: apps/iphone

    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: setup xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: build the app
        run: |
          xcodebuild -project Bönetider.xcodeproj \
            -scheme Bönetider \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            build

      - name: run tests
        run: |
          xcodebuild -project Bönetider.xcodeproj \
            -scheme Bönetider \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            test

      - name: validate version matches root package.json
        run: |
          EXPECTED_VERSION=$(cat ../../package.json | grep -o '"version": "[^"]*"' | cut -d'"' -f4)
          AVAILABLE_VERSION=$(grep 'MARKETING_VERSION = ' Bönetider.xcodeproj/project.pbxproj | head -1 | sed 's/.*MARKETING_VERSION = \(.*\);/\1/')
          echo "Expected version: $EXPECTED_VERSION"
          echo "Available version: $AVAILABLE_VERSION"
          if [ "$AVAILABLE_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "ERROR: Available version ($AVAILABLE_VERSION) must match expected version ($EXPECTED_VERSION)"
            exit 1
          fi

      - name: validate embedded dataset matches data directory
        run: |
          echo "Checking dataset files..."
          ERRORS=0
          for FILE in ../../data/*.json; do
            FILENAME=$(basename "$FILE")
            if [ ! -f "Bönetider/Resources/Values/$FILENAME" ]; then
              echo "ERROR: $FILENAME is missing in Bönetider/Resources/Values/"
              ERRORS=$((ERRORS + 1))
            else
              if ! diff -q "Bönetider/Resources/Values/$FILENAME" "$FILE" > /dev/null 2>&1; then
                echo "ERROR: $FILENAME does not match"
                ERRORS=$((ERRORS + 1))
              else
                echo "✓ $FILENAME matches"
              fi
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "Found $ERRORS error(s)"
            exit 1
          fi
          echo "All dataset files match!"
